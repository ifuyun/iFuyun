<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>helper\util.js - YUIDoc Tool for iFuyun</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="YUIDoc Tool for iFuyun" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/C_Admin.html">C_Admin</a></li>
                                <li><a href="../classes/C_Base.html">C_Base</a></li>
                                <li><a href="../classes/C_Comment.html">C_Comment</a></li>
                                <li><a href="../classes/C_Link.html">C_Link</a></li>
                                <li><a href="../classes/C_Post.html">C_Post</a></li>
                                <li><a href="../classes/C_Taxonomy.html">C_Taxonomy</a></li>
                                <li><a href="../classes/C_User.html">C_User</a></li>
                                <li><a href="../classes/Logger.html">Logger</a></li>
                                <li><a href="../classes/M_Comment.html">M_Comment</a></li>
                                <li><a href="../classes/M_Link.html">M_Link</a></li>
                                <li><a href="../classes/M_Option.html">M_Option</a></li>
                                <li><a href="../classes/M_Post.html">M_Post</a></li>
                                <li><a href="../classes/M_TermRelationship.html">M_TermRelationship</a></li>
                                <li><a href="../classes/M_TermTaxonomy.html">M_TermTaxonomy</a></li>
                                <li><a href="../classes/M_User.html">M_User</a></li>
                                <li><a href="../classes/M_Vote.html">M_Vote</a></li>
                                <li><a href="../classes/Util.html">Util</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/c_admin.html">c_admin</a></li>
                                <li><a href="../modules/c_base.html">c_base</a></li>
                                <li><a href="../modules/c_comment.html">c_comment</a></li>
                                <li><a href="../modules/c_link.html">c_link</a></li>
                                <li><a href="../modules/c_post.html">c_post</a></li>
                                <li><a href="../modules/c_taxonomy.html">c_taxonomy</a></li>
                                <li><a href="../modules/c_user.html">c_user</a></li>
                                <li><a href="../modules/cfg_core.html">cfg_core</a></li>
                                <li><a href="../modules/cfg_database.html">cfg_database</a></li>
                                <li><a href="../modules/cfg_redis.html">cfg_redis</a></li>
                                <li><a href="../modules/cfg_routes.html">cfg_routes</a></li>
                                <li><a href="../modules/cfg_routes_admin.html">cfg_routes_admin</a></li>
                                <li><a href="../modules/index.html">index</a></li>
                                <li><a href="../modules/logger.html">logger</a></li>
                                <li><a href="../modules/m_base.html">m_base</a></li>
                                <li><a href="../modules/m_comment.html">m_comment</a></li>
                                <li><a href="../modules/m_link.html">m_link</a></li>
                                <li><a href="../modules/m_option.html">m_option</a></li>
                                <li><a href="../modules/m_post.html">m_post</a></li>
                                <li><a href="../modules/m_term_relationship.html">m_term_relationship</a></li>
                                <li><a href="../modules/m_term_taxonomy.html">m_term_taxonomy</a></li>
                                <li><a href="../modules/m_user.html">m_user</a></li>
                                <li><a href="../modules/m_vote.html">m_vote</a></li>
                                <li><a href="../modules/util.html">util</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: helper\util.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*jslint nomen:true*/
/**
 * 工具类
 * @module util
 * @class Util
 * @static
 * @requires crypto
 * @author Fuyun
 * @version 2.2.0
 * @since 1.0.0(2014-05-20)
 */
var crypto = require(&#x27;crypto&#x27;);

module.exports = {
    /**
     * 获取分页数据
     * @method formatPages
     * @static
     * @param {Number} page 请求页
     * @param {Number} pages 总页数
     * @param {Number} pagesOut 每页显示页数
     * @return {Object} 分页数据对象
     * @author Fuyun
     * @version 1.0.0(2014-06-01)
     * @since 1.0.0(2014-05-20)
     */
    formatPages: function (page, pages, pagesOut) {
        &#x27;use strict&#x27;;
        var pageData = {
            start: 1,
            end: 1
        }, floorPage, ceilPage;
        // page = page || 1;
        // pages = pages || 1;
        // pagesOut = pagesOut || 9;
        //中间页
        floorPage = Math.floor((pagesOut + 1) / 2);
        //中间页到两边的间距页数，偶数情况距离低页再减一，距离高页不变
        ceilPage = Math.ceil((pagesOut - 1) / 2);

        if (pages &lt;= pagesOut) {//总页数小于一屏输出页数
            pageData.start = 1;
            pageData.end = pages;
        } else if (page &lt;= floorPage) {//第一屏
            pageData.start = 1;
            pageData.end = pagesOut;
        } else if (page &gt; floorPage &amp;&amp; (page + ceilPage) &lt;= pages) {//非第一屏，且非最后一屏
            pageData.start = page - ceilPage + (pagesOut + 1) % 2;
            pageData.end = page + ceilPage;
        } else {//最后一屏
            pageData.start = pages - pagesOut + 1;
            pageData.end = pages;
        }

        return pageData;
    },
    /**
     * 生成分页对象
     * @method paginator
     * @static
     * @param {Number} [page=1] 请求页
     * @param {Number} [pages=1] 总页数
     * @param {Number} [pagesOut=9] 每页显示页数
     * @return {Object} 分页对象
     * @author Fuyun
     * @version 1.0.0(2014-06-01)
     * @since 1.0.0(2014-05-20)
     */
    paginator: function (page, pages, pagesOut) {
        &#x27;use strict&#x27;;
        var pageData, data;

        if ( typeof page === &#x27;string&#x27;) {//page是字符串
            page = parseInt(page, 10);
        }
        page = page || 1;
        pages = pages || 1;
        pagesOut = pagesOut || 9;

        if (page &gt; pages) {
            page = pages;
        }

        pageData = this.formatPages(page, pages, pagesOut);

        data = {
            startPage: pageData.start,
            endPage: pageData.end,
            prevPage: page &lt;= 1 ? 0 : (page - 1),
            nextPage: page &gt;= pages ? 0 : (page + 1),
            curPage: page
        };
        return data;
    },
    /**
     * 根据月份返回月份名称
     * @method getMonthName
     * @static
     * @param {Number} [month=1] 月份(1-12)，默认1
     * @return {String} 月份名称
     * @author Fuyun
     * @version 1.0.0(2014-05-20)
     * @since 1.0.0(2014-05-20)
     */
    getMonthName: function (month) {
        &#x27;use strict&#x27;;
        var monthNames = {
            &#x27;1&#x27;: &#x27;一月&#x27;,
            &#x27;2&#x27;: &#x27;二月&#x27;,
            &#x27;3&#x27;: &#x27;三月&#x27;,
            &#x27;4&#x27;: &#x27;四月&#x27;,
            &#x27;5&#x27;: &#x27;五月&#x27;,
            &#x27;6&#x27;: &#x27;六月&#x27;,
            &#x27;7&#x27;: &#x27;七月&#x27;,
            &#x27;8&#x27;: &#x27;八月&#x27;,
            &#x27;9&#x27;: &#x27;九月&#x27;,
            &#x27;10&#x27;: &#x27;十月&#x27;,
            &#x27;11&#x27;: &#x27;十一&#x27;,
            &#x27;12&#x27;: &#x27;十二&#x27;
        };
        month = parseInt(month, 10);
        if (!month || month &gt; 12 || month &lt; 1) {
            month = 1;
        }

        return monthNames[month];
    },
    /**
     * 截取字符串为指定长度，超过长度加&#x27;...&#x27;
     * @method cutStr
     * @static
     * @param {String} srcStr 源字符串
     * @param {Number} 指定长度
     * @return {String} 截取结果字符串
     * @author Fuyun
     * @version 1.0.0(2014-06-03)
     * @since 1.0.0(2014-05-20)
     */
    cutStr: function (srcStr, cutLength) {
        &#x27;use strict&#x27;;
        var resultStr = &#x27;&#x27;, i = 0, n = 0, curChar;

        srcStr = srcStr || &#x27;&#x27;;
        srcStr = typeof srcStr === &#x27;string&#x27; ? srcStr : &#x27;&#x27;;

        while (n &lt; cutLength &amp;&amp; i &lt; srcStr.length) {
            curChar = srcStr.charCodeAt(i);
            if (curChar &gt;= 192 || (curChar &gt;= 65 &amp;&amp; curChar &lt;= 90)) {//中文和大写字母计为1个
                n += 1;
                if (n &lt;= cutLength) {
                    i += 1;
                }
            } else {//其余字符计为半个
                n += 0.5;
                i += 1;
            }
        }
        resultStr = srcStr.substr(0, i);
        if (srcStr.length &gt; i) {
            resultStr += &#x27;...&#x27;;
        }
        return resultStr;
    },
    /**
     * 过滤HTML标签
     * @method filterHtmlTag
     * @static
     * @param {String} srcStr 源字符串
     * @return {String} 过滤结果字符串
     * @author Fuyun
     * @version 1.0.0(2014-05-20)
     * @since 1.0.0(2014-03-10)
     */
    filterHtmlTag: function (srcStr) {
        &#x27;use strict&#x27;;
        return srcStr.replace(/&lt;\/?[^&gt;]*&gt;/ig, &#x27;&#x27;);
        //\w\s~!@#$%^&amp;*\(\)\-=+\[\]\{\}\\\|;:&#x27;&quot;,\.\/&lt;\?\u4E00-\uFA29
    },
    /**
     * 获取访问者IP
     * @method getRemoteIp
     * @static
     * @param {Object} req 请求对象
     * @return {String} 访问者IP
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getRemoteIp: function (req) {
        &#x27;use strict&#x27;;
        return req.headers[&#x27;x-real-ip&#x27;] || req.headers[&#x27;x-forwarded-for&#x27;] || req.ip || req._remoteAddress || req.connection.remoteAddress || req.socket.remoteAddress || req.connection.socket.remoteAddress;
    },
    /**
     * 获取请求类型
     * @method getHttpMethod
     * @static
     * @param {Object} req 请求对象
     * @return {String} 请求类型
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getHttpMethod: function (req) {
        &#x27;use strict&#x27;;
        return req.method;
    },
    /**
     * 获取请求URL
     * @method getUrl
     * @static
     * @param {Object} req 请求对象
     * @return {String} 请求URL
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getUrl: function (req) {
        &#x27;use strict&#x27;;
        return req.originalUrl || req.url;
    },
    /**
     * 获取响应状态码
     * @method getHttpStatus
     * @static
     * @param {Object} res 响应对象
     * @return {Number} 响应状态码
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getHttpStatus: function (res) {
        &#x27;use strict&#x27;;
        return res.statusCode || &#x27;&#x27;;
    },
    /**
     * 获取访客信息
     * @method getUserAgent
     * @static
     * @param {Object} req 请求对象
     * @return {String} UserAgent
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getUserAgent: function (req) {
        &#x27;use strict&#x27;;
        return req.headers[&#x27;user-agent&#x27;];
    },
    /**
     * 获取HTTP协议版本
     * @method getHttpVersion
     * @static
     * @param {Object} req 请求对象
     * @return {String} HTTP协议版本
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getHttpVersion: function (req) {
        &#x27;use strict&#x27;;
        return req.httpVersionMajor + &#x27;.&#x27; + req.httpVersionMinor;
    },
    /**
     * 获取来源页地址
     * @method getReferrer
     * @static
     * @param {Object} req 请求对象
     * @return {String} 来源页地址
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getReferrer: function (req) {
        &#x27;use strict&#x27;;
        return req.headers.referer || req.headers.referrer;
    },
    /**
     * 获取指定的响应头字段值
     * @method getResponseHeader
     * @static
     * @param {Object} res 响应对象
     * @param {String} field 响应头字段名
     * @return {Array|String} 指定的响应头字段值
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getResponseHeader: function (res, field) {
        &#x27;use strict&#x27;;
        if (!res._header) {
            return;
        }

        var header = res.getHeader(field);

        return Array.isArray(header) ? header.join(&#x27;, &#x27;) : header;
    },
    /**
     * 获取响应内容长度
     * @method getContentLength
     * @static
     * @param {Object} res 响应对象
     * @return {Number} 响应内容长度
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getContentLength: function (res) {
        &#x27;use strict&#x27;;
        return this.getResponseHeader(res, &#x27;content-length&#x27;);
    },
    /**
     * 获取访问日志
     * @method getAccessLog
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @return {String} 访问日志
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getAccessLog: function (req, res) {
        &#x27;use strict&#x27;;
        return this.getRemoteIp(req) + &#x27; - &#x27; + this.getHttpMethod(req) + &#x27; &#x27; + this.getHttpStatus(res) + &#x27; &#x27; + this.getUrl(req);
    },
    /**
     * 获取访客信息
     * @method getAccessUser
     * @static
     * @param {Object} req 请求对象
     * @return {String} 访客信息
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getAccessUser: function(req){
        &#x27;use strict&#x27;;
        return this.getRemoteIp(req) + &#x27; - &quot;&#x27; + this.getUserAgent(req) + &#x27;&quot;&#x27;;
    },
    /**
     * 生成Error对象，返回错误页或错误对象
     * @method catchError
     * @static
     * @param {Object} msgObj 消息对象
     *      {Number}[status=404] HTTP状态码
     *      {Number}[code=404] 错误码
     *      {String}[message=&#x27;Page Not Found&#x27;] 错误消息
     * @param {Object} next 路由对象
     * @return {Error} 错误对象
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    catchError: function (msgObj, next) {
        &#x27;use strict&#x27;;
        msgObj.message = msgObj.message || &#x27;Page Not Found&#x27;;
        msgObj.status = msgObj.status || 404;
        msgObj.code = msgObj.code || 404;
        if (next) {
            return next(msgObj);
        }
        return msgObj;
    },
    /**
     * md5加密字符串
     * @method md5
     * @static
     * @param {String} str 源字符串
     * @return {String} 加密结果
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    md5: function (str) {
        &#x27;use strict&#x27;;
        var md5sum = crypto.createHash(&#x27;md5&#x27;);
        md5sum.update(str);
        return md5sum.digest(&#x27;hex&#x27;);
    },
    /**
     * 拼接标题
     * @method getTitle
     * @static
     * @param {String|Array} titleArr 标题数组
     * @param {String} [delimiter=&#x27; - &#x27;] 分隔符
     * @return {String} 拼接结果字符串
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getTitle: function (titleArr, delimiter) {
        &#x27;use strict&#x27;;
        delimiter = delimiter || &#x27; - &#x27;;
        if ( typeof titleArr === &#x27;string&#x27;) {
            titleArr = [titleArr];
        }

        return titleArr.join(delimiter);
    },
    /**
     * 生成随机ID字符串：10/11位十六进制时间戳+6/5位十六进制随机数
     * @method getUuid
     * @static
     * @return {String} ID
     * @author Fuyun
     * @version 1.0.0(2014-06-18)
     * @since 1.0.0(2014-06-17)
     */
    getUuid: function () {
        &#x27;use strict&#x27;;
        //1e12 + 0x4ba0000000
        var timeStamp = new Date ().getTime() - 1324806901760, uuid = timeStamp.toString(16), idx = 0, tmpStr = &#x27;&#x27;;

        for ( idx = 0; idx &lt; 16 - uuid.length; idx += 1) {
            tmpStr += Math.floor(Math.random() * 16).toString(16);
        }

        return uuid + tmpStr;
    },
    /**
     * 判断是否空对象
     * @method isEmptyObject
     * @static
     * @param {Object} obj 源对象
     * @return {Boolean} 判断结果：为空返回true，否则返回false
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    isEmptyObject: function (obj) {
        &#x27;use strict&#x27;;
        var name;
        for (name in obj ) {
            if (obj.hasOwnProperty(name)) {
                return false;
            }
        }
        return true;
    },
    /**
     * 判断数组是否含有指定元素
     * @method inArray
     * @static
     * @param {mixed} elem 元素
     * @param {Array} arr 数组
     * @param {Number} i 判断起始位置
     * @return {Number} 判断结果：找到返回所在位置，否则返回-1
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    inArray: function (elem, arr, i) {
        &#x27;use strict&#x27;;
        var len;
        if (arr) {
            len = arr.length;
            i = i ? i &lt; 0 ? Math.max(0, len + i) : i : 0;

            while (i &lt; len) {
                // Skip accessing in sparse arrays
                if (arr.hasOwnProperty(i) &amp;&amp; arr[i] === elem) {
                    return i;
                }
                i += 1;
            }
        }

        return -1;
    },
    /**
     * 判断是否数组
     * @method isArray
     * @static
     * @param {mixed} obj 任意对象
     * @return {Boolean} 判断结果：数组返回true，非数组返回false
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    isArray: function(obj){
        &#x27;use strict&#x27;;
        return Object.prototype.toString.call(obj) === &#x27;[object Array]&#x27;;
    },
    /**
     * 判断是否已登录
     * @method isLogin
     * @static
     * @param {Object} req 请求对象
     * @return {Boolean} 判断结果：已登录返回true，否则返回false
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    isLogin: function(req){
        &#x27;use strict&#x27;;
        var curUser = req.session.user;
        return curUser ? !!curUser : false;
    },
    /**
     * 判断登录用户是否管理员
     * @method isAdminUser
     * @static
     * @param {Object} req 请求对象
     * @return {Boolean} 判断结果：是管理员返回true，否则返回false
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    isAdminUser: function(req) {
        &#x27;use strict&#x27;;
        var curUser = req.session.user;
        return this.isLogin(req) &amp;&amp; curUser.usermeta &amp;&amp; curUser.usermeta.role === &#x27;admin&#x27;;
    },
    /**
     * 获取错误日志
     * @method getErrorLog
     * @static
     * @param {Object} logObj 日志数据对象
     * @return {String} 日志内容
     * @author Fuyun
     * @version 2.2.0
     * @since 2.2.0
     */
    getErrorLog: function(logObj){
        &#x27;use strict&#x27;;
        // logObj = {
            // req: &#x27;&#x27;,
            // funcName: &#x27;&#x27;,
            // funcParam: {},
            // msg: &#x27;&#x27;
        // };
        // IP - &quot;UserAgent&quot; - &quot;Function: function, Param: {&quot;a&quot;:&quot;b&quot;,&quot;c&quot;:&quot;d&quot;}, Error: some error&quot;
        var errStr = &#x27;&#x27;;
        
        errStr += this.getAccessUser(logObj.req);
        errStr += &#x27; - &quot;Function: &#x27; + logObj.funcName + &#x27;, Param: &#x27; + JSON.stringify(logObj.funcParam) + &#x27;, Error: &#x27; + logObj.msg + &#x27;&quot;&#x27;;
        
        return errStr;
    },
    /**
     * 获取操作日志
     * @method getInfoLog
     * @static
     * @param {Object} logObj 日志数据对象
     * @return {String} 日志内容
     * @author Fuyun
     * @version 2.2.0
     * @since 2.2.0
     */
    getInfoLog: function(logObj){
        &#x27;use strict&#x27;;
        var logStr = &#x27;&#x27;;

        logStr += this.getAccessUser(logObj.req);
        logStr += &#x27; - &quot;Function: &#x27; + logObj.funcName + &#x27;, Param: &#x27; + JSON.stringify(logObj.funcParam) + &#x27;, Msg: &#x27; + logObj.msg + &#x27;&quot;&#x27;;

        return logStr;
    }
};

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
