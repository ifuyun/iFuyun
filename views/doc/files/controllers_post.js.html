<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>controllers\post.js - YUIDoc Tool for iFuyun</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="YUIDoc Tool for iFuyun" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 1.0.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/C_Admin.html">C_Admin</a></li>
                                <li><a href="../classes/C_Base.html">C_Base</a></li>
                                <li><a href="../classes/C_Comment.html">C_Comment</a></li>
                                <li><a href="../classes/C_Link.html">C_Link</a></li>
                                <li><a href="../classes/C_Post.html">C_Post</a></li>
                                <li><a href="../classes/C_Taxonomy.html">C_Taxonomy</a></li>
                                <li><a href="../classes/C_User.html">C_User</a></li>
                                <li><a href="../classes/Logger.html">Logger</a></li>
                                <li><a href="../classes/M_Comment.html">M_Comment</a></li>
                                <li><a href="../classes/M_Link.html">M_Link</a></li>
                                <li><a href="../classes/M_Option.html">M_Option</a></li>
                                <li><a href="../classes/M_Post.html">M_Post</a></li>
                                <li><a href="../classes/M_TermRelationship.html">M_TermRelationship</a></li>
                                <li><a href="../classes/M_TermTaxonomy.html">M_TermTaxonomy</a></li>
                                <li><a href="../classes/M_User.html">M_User</a></li>
                                <li><a href="../classes/M_Vote.html">M_Vote</a></li>
                                <li><a href="../classes/Util.html">Util</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/c_admin.html">c_admin</a></li>
                                <li><a href="../modules/c_base.html">c_base</a></li>
                                <li><a href="../modules/c_comment.html">c_comment</a></li>
                                <li><a href="../modules/c_link.html">c_link</a></li>
                                <li><a href="../modules/c_post.html">c_post</a></li>
                                <li><a href="../modules/c_taxonomy.html">c_taxonomy</a></li>
                                <li><a href="../modules/c_user.html">c_user</a></li>
                                <li><a href="../modules/cfg_core.html">cfg_core</a></li>
                                <li><a href="../modules/cfg_database.html">cfg_database</a></li>
                                <li><a href="../modules/cfg_redis.html">cfg_redis</a></li>
                                <li><a href="../modules/cfg_routes.html">cfg_routes</a></li>
                                <li><a href="../modules/cfg_routes_admin.html">cfg_routes_admin</a></li>
                                <li><a href="../modules/index.html">index</a></li>
                                <li><a href="../modules/logger.html">logger</a></li>
                                <li><a href="../modules/m_base.html">m_base</a></li>
                                <li><a href="../modules/m_comment.html">m_comment</a></li>
                                <li><a href="../modules/m_link.html">m_link</a></li>
                                <li><a href="../modules/m_option.html">m_option</a></li>
                                <li><a href="../modules/m_post.html">m_post</a></li>
                                <li><a href="../modules/m_term_relationship.html">m_term_relationship</a></li>
                                <li><a href="../modules/m_term_taxonomy.html">m_term_taxonomy</a></li>
                                <li><a href="../modules/m_user.html">m_user</a></li>
                                <li><a href="../modules/m_vote.html">m_vote</a></li>
                                <li><a href="../modules/util.html">util</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: controllers\post.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*global console*/
/**
 * 主控制器：文章列表和详情
 * @module c_post
 * @class C_Post
 * @static
 * @requires fs, path, url, iconv-lite, async, sanitizer, formidable, moment, c_base, m_base, util, logger, m_post, m_link, m_term_taxonomy
 * @author Fuyun
 * @version 1.2.0
 * @since 1.0.0(2014-05-16)
 */
var fs = require(&#x27;fs&#x27;),
    path = require(&#x27;path&#x27;),
    url = require(&#x27;url&#x27;),
    iconv = require(&#x27;iconv-lite&#x27;),
    async = require(&#x27;async&#x27;),
    xss = require(&#x27;sanitizer&#x27;),
    formidable = require(&#x27;formidable&#x27;),
    moment = require(&#x27;moment&#x27;),

    base = require(&#x27;./base&#x27;),
    pool = require(&#x27;../model/base&#x27;).pool,
    util = require(&#x27;../helper/util&#x27;),
    Logger = require(&#x27;../helper/logger&#x27;),
    logger = Logger.sysLog,

    PostModel = require(&#x27;../model/post&#x27;),
    LinkModel = require(&#x27;../model/link&#x27;),
    TaxonomyModel = require(&#x27;../model/termTaxonomy&#x27;),

    post = new PostModel(pool),
    link = new LinkModel(pool),
    taxonomy = new TaxonomyModel(pool),

    pagesOut = 9,
    idReg = /^[0-9a-fA-F]{16}$/i,
    // pageReg = /^[1-9][0-9]*$/i,

    common;

//共用方法
common = {
    /**
     * 公共方法：查询首页链接
     * @method getHomeLinks
     * @static
     * @param {Function} cb 回调
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getHomeLinks: function (cb) {
        &#x27;use strict&#x27;;
        link.getHomeLinks(cb);
    },
    /**
     * 公共方法：查询站点（非首页）链接
     * @method getSiteLinks
     * @static
     * @param {Function} cb 回调
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getSiteLinks: function (cb) {
        &#x27;use strict&#x27;;
        link.getSiteLinks(cb);
    },
    /**
     * 公共方法：根据前序遍历查询目录(包含子目录)
     * @method getCategoryArray
     * @static
     * @param {Function} cb 回调
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getCategoryArray: function (cb) {
        &#x27;use strict&#x27;;
        taxonomy.getCategoryArray(&#x27;post&#x27;, cb);
    },
    /**
     * 公共方法：查询全局自动加载的配置项
     * @method getOptions
     * @static
     * @param {Function} cb 回调
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getOptions: function (cb) {
        &#x27;use strict&#x27;;
        base.initOption(cb);
    },
    /**
     * 公共方法：查询公共的基础数据：归档日期、最近post、随机post、热门post、友情链接、顶部链接、分类目录、主导航、站点配置
     * @method getCommonData
     * @static
     * @param {Function} cb 回调
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    getCommonData: function (param, cb) {
        &#x27;use strict&#x27;;
        async.parallel({
            archiveDates: function (cb) {//查询post归档日期, TODO:不能直接用post.getArchiveDates，否则this将引用异常(apply)
                post.getArchiveDates(&#x27;post&#x27;, cb);
            },
            recentPosts: function (cb) {//查询最近post
                post.getRecentPosts(cb);
            },
            randPosts: function (cb) {//查询随机post
                post.getRandPosts(cb);
            },
            hotPosts: function (cb) {//查询热门post
                post.getHotPosts(cb);
            },
            friendLinks: param.from !== &#x27;list&#x27; || param.page &gt; 1 ? common.getSiteLinks : common.getHomeLinks,
            quickLinks: function (cb) {//查询顶部链接
                link.getQuickLinks(cb);
            },
            // categories: function (cb) {//查询目录(包含子目录)HTML
            //     taxonomy.getCategoryDom(cb);
            // },
            categories: function (cb) {//查询目录(包含子目录)
                taxonomy.getCategoryTree(cb);
            },
            mainNavs: function (cb) {//查询主导航
                taxonomy.getMainNavs(cb);
            },
            options: common.getOptions
        }, function (err, results) {
            if (err) {
                cb(err);
            } else {
                cb(null, results);
            }
        });
    }
};

module.exports = {
    /**
     * 显示所有文章列表
     * @method listPosts
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.0.0(2014-06-12)
     * @since 1.0.0(2014-05-25)
     */
    listPosts: function (req, res, next) {
        &#x27;use strict&#x27;;
        var page = parseInt(req.params.page, 10) || 1, resData;

        resData = {
            curNav: &#x27;index&#x27;,
            showCrumb: false,
            postsData: false,
            archiveDates: false,
            mainNavs: false,
            categories: false,
            friendLinks: false,
            recentPosts: false,
            randPosts: false,
            options: false,
            quickLinks: false,
            meta: {
                title: &#x27;&#x27;,
                description: &#x27;&#x27;,
                keywords: &#x27;&#x27;,
                author: &#x27;&#x27;
            }
        };

        async.parallel({
            allPosts: function (cb) {
                post.getAllPosts({
                    page: page,
                    postStatus: &#x27;publish&#x27;,
                    category: &#x27;&#x27;,
                    tag: &#x27;&#x27;,
                    author: &#x27;&#x27;,
                    keyword: req.query.keyword || &#x27;&#x27;
                }, cb);
            },
            commonData: function (cb) {
                common.getCommonData({
                    page: page,
                    from: &#x27;list&#x27;
                }, cb);
            }
        }, function (err, results) {
            if (err) {
                next(err);
            } else {
                var options = results.commonData.options;

                resData.postsData = results.allPosts;
                resData.postsData.paginator = util.paginator(page, results.allPosts.pages, pagesOut);
                resData.postsData.linkUrl = &#x27;/post/page-&#x27;;
                resData.postsData.linkParam = req.query.keyword ? &#x27;?keyword=&#x27; + req.query.keyword : &#x27;&#x27;;

                if (req.query.keyword) {
                    if (page &gt; 1) {
                        resData.meta.title = util.getTitle([req.query.keyword, &#x27;第&#x27; + page + &#x27;页&#x27;, &#x27;搜索结果&#x27;, options.site_name.option_value]);
                    } else {
                        resData.meta.title = util.getTitle([req.query.keyword, &#x27;搜索结果&#x27;, options.site_name.option_value]);
                    }
                } else {
                    if (page &gt; 1) {
                        resData.meta.title = util.getTitle([&#x27;第&#x27; + page + &#x27;页&#x27;, &#x27;文章列表&#x27;, options.site_name.option_value]);
                    } else {
                        resData.meta.title = util.getTitle([&#x27;爱生活，爱抚云&#x27;, options.site_name.option_value]);
                    }
                }

                resData.meta.description = (page &gt; 1 ? &#x27;[文章列表](第&#x27; + page + &#x27;页)&#x27; : &#x27;&#x27;) + options.site_description.option_value;
                resData.meta.keywords = options.site_keywords.option_value;
                resData.meta.author = options.site_author.option_value;

                Object.assign(resData, results.commonData);

                resData.util = util;
                res.render(&#x27;v2/pages/postList&#x27;, resData);
            }
        });
    },
    /**
     * 显示文章内容(即单篇博文)
     * @method showPost
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.0.0(2015-02-25)
     * @since 1.0.0(2014-05-25)
     */
    showPost: function (req, res, next) {
        &#x27;use strict&#x27;;
        var postId = req.params.postId, page = req.params.page || 1, resData;

        if (!postId || !idReg.test(postId)) {
            return util.catchError({
                status: 404,
                code: 404,
                message: &#x27;Page Not Found&#x27;
            }, next);
        }

        resData = {
            curNav: &#x27;&#x27;,
            curPos: &#x27;&#x27;,
            showCrumb: true,
            post: false,
            archiveDates: false,
            mainNavs: false,
            categories: false,
            friendLinks: false,
            recentPosts: false,
            randPosts: false,
            options: false,
            quickLinks: false,
            user: {
                userName: &#x27;&#x27;,
                userEmail: &#x27;&#x27;
            },
            meta: {
                title: &#x27;&#x27;,
                description: &#x27;&#x27;,
                keywords: &#x27;&#x27;,
                author: &#x27;&#x27;
            },
            token: req.csrfToken()
        };

        if (req.session.user) {
            resData.user.userName = req.session.user.user.user_display_name;
            resData.user.userEmail = req.session.user.user.user_email;
        }

        async.auto({
            post: function (cb) {
                post.getPostById(postId, &#x27;id&#x27;, util.isAdminUser(req), function (err, data) {
                    if (err || !data.post || !data.post.post_id) {
                        logger.error(util.getErrorLog({
                            req: req,
                            funcName: &#x27;showPost&#x27;,//TODO:func.name
                            funcParam: {
                                postId: postId
                            },
                            msg: err
                        }));
                        return cb(util.catchError({
                            status: 404,
                            code: 404,
                            message: &#x27;Page Not Found&#x27;
                        }));
                    }
                    if (!util.isAdminUser(req) &amp;&amp; data.post.post_status !== &#x27;publish&#x27;) {//无管理员权限不允许访问非公开文章(包括草稿)
                        // logger.warn(util.getAccessUser(req), &#x27;- &quot;postId: &#x27; + data.post.post_id + &#x27; is &#x27; + data.post.post_status + &#x27;&quot;&#x27;);
                        logger.warn(util.getErrorLog({
                            req: req,
                            funcName: &#x27;showPost&#x27;,
                            funcParam: {
                                postId: data.post.post_id,
                                postTitle: data.post.post_title
                            },
                            msg: data.post.post_title + &#x27; is &#x27; + data.post.post_status
                        }));
                        return cb(util.catchError({
                            status: 404,
                            code: 404,
                            message: &#x27;Page Not Found&#x27;
                        }));
                    }
                    cb(null, data);
                });
            },
            //@formatter:off
            crumb: [&#x27;post&#x27;,
                function (cb, results) {//因为无需再次查询前置条件，故单独同post并行，而无需合并到post处理中，区别于目录列表
                    if (!results.post.category[0] || !results.post.category[0].parent) {
                        cb();
                    } else {
                        taxonomy.getParentCategories(results.post.category[0].parent, cb);
                    }
                }],
            getPrev: [&#x27;post&#x27;, function(cb, results){
                post.getPrevPost(postId, cb);
            }],
            getNext: [&#x27;post&#x27;, function(cb, results){
                post.getNextPost(postId, cb);
            }],
            //@formatter:on
            commonData: function (cb) {
                common.getCommonData({}, cb);
            }
        }, function (err, results) {
            var crumb = [], curPost = results.post, crumbData = results.crumb, crumbIdx, options = results.commonData.options, tagIdx, tagArr = [];

            if (err) {
                return next(err);
            }
            if (!curPost.category[0]) {
                return next(&#x27;分类不存在&#x27;);
            }

            crumb.push({
                &#x27;title&#x27;: &#x27;首页&#x27;,
                &#x27;tooltip&#x27;: &#x27;iFuyun&#x27;,
                &#x27;url&#x27;: &#x27;/&#x27;,
                &#x27;headerFlag&#x27;: false
            });

            if (crumbData) {
                resData.curNav = crumbData[0].slug;
                for (crumbIdx = 0; crumbIdx &lt; crumbData.length; crumbIdx += 1) {
                    crumb.push({
                        &#x27;title&#x27;: crumbData[crumbIdx].name,
                        &#x27;tooltip&#x27;: crumbData[crumbIdx].description,
                        &#x27;url&#x27;: &#x27;/category/&#x27; + crumbData[crumbIdx].slug,
                        &#x27;headerFlag&#x27;: false
                    });
                }
            } else {
                resData.curNav = curPost.category[0].slug;
            }
            crumb.push({
                &#x27;title&#x27;: curPost.category[0].name,
                &#x27;tooltip&#x27;: curPost.category[0].description,
                &#x27;url&#x27;: &#x27;/category/&#x27; + curPost.category[0].slug,
                &#x27;headerFlag&#x27;: true
            });
            resData.curPos = base.createCrumb(crumb);

            if (page &gt; 1) {
                resData.meta.title = util.getTitle([&#x27;第&#x27; + page + &#x27;页&#x27;, curPost.post.post_title, options.site_name.option_value]);
            } else {
                resData.meta.title = util.getTitle([curPost.post.post_title, options.site_name.option_value]);
            }
            for (tagIdx = 0; tagIdx &lt; curPost.tag.length; tagIdx += 1) {
                tagArr.push(curPost.tag[tagIdx].name);
            }
            tagArr.push(options.site_keywords.option_value);

            resData.meta.description = (page &gt; 1 ? &#x27;(第&#x27; + page + &#x27;页)&#x27; : &#x27;&#x27;) + (curPost.post.post_excerpt || util.cutStr(util.filterHtmlTag(curPost.post.post_content), 140));
            resData.meta.keywords = tagArr.join(&#x27;,&#x27;);
            resData.meta.author = options.site_author.option_value;
            //curPost.author.user_display_name + &#x27;,&#x27; +

            resData.post = curPost;
            resData.comments = curPost.comments;

            Object.assign(resData, results.commonData);

            resData.util = util;
            resData.prevPost = results.getPrev;
            resData.nextPost = results.getNext;

            res.render(&#x27;v2/pages/post&#x27;, resData);
        });
    },
    /**
     * 显示页面内容(即单篇页面)
     * @method showPage
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    showPage: function (req, res, next) {//req.connection.remoteAddress,req.url,req.originalUrl
        &#x27;use strict&#x27;;
        var reqUrl = url.parse(req.url), reqPath = reqUrl.pathname, resData;

        resData = {
            curNav: &#x27;&#x27;,
            curPos: &#x27;&#x27;,
            showCrumb: false,
            post: false,
            archiveDates: false,
            mainNavs: false,
            categories: false,
            friendLinks: false,
            recentPosts: false,
            randPosts: false,
            options: false,
            quickLinks: false,
            user: {
                userName: &#x27;&#x27;,
                userEmail: &#x27;&#x27;
            },
            meta: {
                title: &#x27;&#x27;,
                description: &#x27;&#x27;,
                keywords: &#x27;&#x27;,
                author: &#x27;&#x27;
            },
            token: req.csrfToken()
        };

        if (req.session.user) {
            resData.user.userName = req.session.user.user.user_display_name;
            resData.user.userEmail = req.session.user.user.user_email;
        }

        async.auto({
            post: function (cb) {
                post.getPostById(reqPath, &#x27;guid&#x27;, util.isAdminUser(req), function (err, data) {
                    if (err || !data.post || !data.post.post_id) {
                        logger.error(util.getErrorLog({
                            req: req,
                            funcName: &#x27;showPage&#x27;,
                            funcParam: {
                                reqPath: reqPath
                            },
                            msg: err
                        }));
                        return cb(util.catchError({
                            status: 404,
                            code: 404,
                            message: &#x27;Page Not Found&#x27;
                        }));
                    }
                    if (!util.isAdminUser(req) &amp;&amp; data.post.post_status !== &#x27;publish&#x27;) {//无管理员权限不允许访问非公开文章(包括草稿)
                        // logger.warn(util.getAccessUser(req), &#x27;- &quot;postId: &#x27; + data.post.post_id + &#x27; is &#x27; + data.post.post_status + &#x27;&quot;&#x27;);
                        logger.warn(util.getErrorLog({
                            req: req,
                            funcName: &#x27;showPage&#x27;,
                            funcParam: {
                                postId: data.post.post_id,
                                postTitle: data.post.post_title
                            },
                            msg: data.post.post_title + &#x27; is &#x27; + data.post.post_status
                        }));
                        return cb(util.catchError({
                            status: 404,
                            code: 404,
                            message: &#x27;Page Not Found&#x27;
                        }));
                    }
                    cb(null, data);
                });
            },
            commonData: function (cb) {
                common.getCommonData({}, cb);
            }
        }, function (err, results) {
            var curPost = results.post, options = results.commonData.options, tagArr = [];

            if (err) {
                return next(err);
            }

            tagArr.push(options.site_keywords.option_value);

            resData.meta.title = util.getTitle([curPost.post.post_title, options.site_name.option_value]);
            resData.meta.description = (curPost.post.post_excerpt || util.cutStr(util.filterHtmlTag(curPost.post.post_content), 140));//TODO
            resData.meta.keywords = tagArr.join(&#x27;,&#x27;);
            resData.meta.author = options.site_author.option_value;
            //curPost.author.user_display_name + &#x27;,&#x27; +

            resData.post = curPost;
            resData.comments = curPost.comments;

            Object.assign(resData, results.commonData);

            resData.util = util;

            res.render(&#x27;v2/pages/page&#x27;, resData);
        });
        // next();
    },
    /**
     * 根据日期(年月)显示归档文章列表
     * @method listByDate
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    listByDate: function (req, res, next) {
        &#x27;use strict&#x27;;
        var page = parseInt(req.params.page, 10) || 1,
            year = parseInt(req.params.year, 10) || new Date().getFullYear(),
            month = parseInt(req.params.month, 10) || (new Date().getMonth() + 1),
            resData;

        resData = {
            curNav: &#x27;index&#x27;,
            curPos: &#x27;&#x27;,
            showCrumb: true,
            postsData: false,
            archiveDates: false,
            mainNavs: false,
            categories: false,
            friendLinks: false,
            recentPosts: false,
            randPosts: false,
            options: false,
            quickLinks: false,
            meta: {
                title: &#x27;&#x27;,
                description: &#x27;&#x27;,
                keywords: &#x27;&#x27;,
                author: &#x27;&#x27;
            }
        };

        async.parallel({
            allPosts: function (cb) {
                post.getPostsByDate({
                    year: year,
                    month: req.params.month ? (month &lt; 10 ? &#x27;0&#x27; + month : month) : &#x27;&#x27;,
                    page: page,
                    postStatus: &#x27;publish&#x27;,
                    category: &#x27;&#x27;,
                    tag: &#x27;&#x27;,
                    author: &#x27;&#x27;,
                    keyword: req.query.keyword || &#x27;&#x27;
                }, cb);
            },
            commonData: function (cb) {
                common.getCommonData({}, cb);
            }
        }, function (err, results) {
            var crumb = [], options = results.commonData.options, title = &#x27;&#x27;;
            if (err) {
                next(err);
            } else {
                crumb = [{
                    &#x27;title&#x27;: &#x27;首页&#x27;,
                    &#x27;tooltip&#x27;: &#x27;iFuyun&#x27;,
                    &#x27;url&#x27;: &#x27;/&#x27;,
                    &#x27;headerFlag&#x27;: false
                }, {
                    &#x27;title&#x27;: &#x27;文章归档&#x27;,
                    &#x27;tooltip&#x27;: &#x27;文章归档&#x27;,
                    &#x27;url&#x27;: &#x27;&#x27;,
                    &#x27;headerFlag&#x27;: false
                }, {
                    &#x27;title&#x27;: year + &#x27;年&#x27;,
                    &#x27;tooltip&#x27;: year + &#x27;年&#x27;,
                    &#x27;url&#x27;: &#x27;/archive/&#x27; + year,
                    &#x27;headerFlag&#x27;: !req.params.month
                }];
                if (req.params.month) {
                    crumb.push({
                        &#x27;title&#x27;: month + &#x27;月&#x27;,
                        &#x27;tooltip&#x27;: year + &#x27;年&#x27; + month + &#x27;月&#x27;,
                        &#x27;url&#x27;: &#x27;/archive/&#x27; + year + &#x27;/&#x27; + month,
                        &#x27;headerFlag&#x27;: true
                    });
                }

                resData.postsData = results.allPosts;
                resData.postsData.paginator = util.paginator(page, results.allPosts.pages, pagesOut);
                resData.postsData.linkUrl = &#x27;/archive/&#x27; + year + (req.params.month ? (&#x27;/&#x27; + (month &lt; 10 ? &#x27;0&#x27; + month : month)) : &#x27;&#x27;) + &#x27;/page-&#x27;;
                resData.postsData.linkParam = &#x27;&#x27;;

                resData.curPos = base.createCrumb(crumb);

                title = req.params.month ? year + &#x27;年&#x27; + month + &#x27;月&#x27; : year + &#x27;年&#x27;;
                if (page &gt; 1) {
                    resData.meta.title = util.getTitle([&#x27;第&#x27; + page + &#x27;页&#x27;, title, &#x27;文章归档&#x27;, options.site_name.option_value]);
                } else {
                    resData.meta.title = util.getTitle([title, &#x27;文章归档&#x27;, options.site_name.option_value]);
                }

                resData.meta.description = &#x27;[&#x27; + title + &#x27;]&#x27; + (page &gt; 1 ? &#x27;(第&#x27; + page + &#x27;页)&#x27; : &#x27;&#x27;) + options.site_description.option_value;
                resData.meta.keywords = options.site_keywords.option_value;
                resData.meta.author = options.site_author.option_value;

                Object.assign(resData, results.commonData);

                resData.util = util;

                res.render(&#x27;v2/pages/postList&#x27;, resData);
            }
        });
    },
    /**
     * 根据分类目录显示文章列表
     * @method listByCategory
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    listByCategory: function (req, res, next) {
        &#x27;use strict&#x27;;
        //@formatter:off
        var page = parseInt(req.params.page, 10) || 1,
            category = req.params.category,
            resData;
        //@formatter:on

        resData = {
            curNav: &#x27;&#x27;,
            curPos: &#x27;&#x27;,
            showCrumb: true,
            postsData: false,
            archiveDates: false,
            mainNavs: false,
            categories: false,
            friendLinks: false,
            recentPosts: false,
            randPosts: false,
            options: false,
            quickLinks: false,
            meta: {
                title: &#x27;&#x27;,
                description: &#x27;&#x27;,
                keywords: &#x27;&#x27;,
                author: &#x27;&#x27;
            }
        };

        async.parallel({
            allPosts: function (cb) {
                post.getPostsByCategories({
                    page: page,
                    postStatus: &#x27;publish&#x27;,
                    postDate: req.query.date || &#x27;&#x27;,
                    category: category,
                    tag: &#x27;&#x27;,
                    author: &#x27;&#x27;,
                    keyword: req.query.keyword || &#x27;&#x27;
                }, cb);
            },
            commonData: function (cb) {
                common.getCommonData({}, cb);
            }
        }, function (err, results) {
            var crumb = [], crumbIdx, crumbData, options = results.commonData.options, title = &#x27;&#x27;;
            if (err) {
                return next(err);
            }
            if (!results.allPosts) {
                return util.catchError({
                    status: 404,
                    code: 404,
                    message: &#x27;Page Not Found&#x27;
                }, next);
            }
            crumbData = results.allPosts.crumb;
            crumb = [{
                &#x27;title&#x27;: &#x27;首页&#x27;,
                &#x27;tooltip&#x27;: &#x27;iFuyun&#x27;,
                &#x27;url&#x27;: &#x27;/&#x27;,
                &#x27;headerFlag&#x27;: false
            }];
            for (crumbIdx = 0; crumbIdx &lt; crumbData.length; crumbIdx += 1) {
                crumb.push({
                    &#x27;title&#x27;: crumbData[crumbIdx].name,
                    &#x27;tooltip&#x27;: crumbData[crumbIdx].description,
                    &#x27;url&#x27;: &#x27;/category/&#x27; + crumbData[crumbIdx].slug,
                    &#x27;headerFlag&#x27;: crumbIdx === crumbData.length - 1 ? true : false
                });
            }

            resData.postsData = results.allPosts;
            resData.postsData.paginator = util.paginator(page, results.allPosts.pages, pagesOut);

            resData.postsData.linkUrl = &#x27;/category/&#x27; + category + &#x27;/page-&#x27;;
            resData.postsData.linkParam = &#x27;&#x27;;

            resData.curNav = crumbData[0].slug;
            resData.curPos = base.createCrumb(crumb);

            title = crumb[crumbData.length].title;
            if (page &gt; 1) {
                resData.meta.title = util.getTitle([&#x27;第&#x27; + page + &#x27;页&#x27;, title, &#x27;分类目录&#x27;, options.site_name.option_value]);
            } else {
                resData.meta.title = util.getTitle([title, &#x27;分类目录&#x27;, options.site_name.option_value]);
            }

            resData.meta.description = &#x27;[&#x27; + title + &#x27;]&#x27; + (page &gt; 1 ? &#x27;(第&#x27; + page + &#x27;页)&#x27; : &#x27;&#x27;) + options.site_description.option_value;
            resData.meta.keywords = options.site_keywords.option_value;
            resData.meta.author = options.site_author.option_value;

            Object.assign(resData, results.commonData);

            resData.util = util;

            res.render(&#x27;v2/pages/postList&#x27;, resData);
        });
    },
    /**
     * 根据标签显示文章列表
     * @method listByTag
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    listByTag: function (req, res, next) {
        &#x27;use strict&#x27;;
        //@formatter:off
        var page = parseInt(req.params.page, 10) || 1,
            tag = req.params.tag,
            resData;
        //@formatter:on

        resData = {
            curNav: &#x27;&#x27;,
            curPos: &#x27;&#x27;,
            showCrumb: true,
            postsData: false,
            archiveDates: false,
            mainNavs: false,
            categories: false,
            friendLinks: false,
            recentPosts: false,
            randPosts: false,
            options: false,
            quickLinks: false,
            meta: {
                title: &#x27;&#x27;,
                description: &#x27;&#x27;,
                keywords: &#x27;&#x27;,
                author: &#x27;&#x27;
            }
        };

        async.parallel({
            allPosts: function (cb) {
                post.getPostsByTag({
                    page: page,
                    postStatus: &#x27;publish&#x27;,
                    postDate: req.query.date || &#x27;&#x27;,
                    category: &#x27;&#x27;,
                    tag: tag,
                    author: &#x27;&#x27;,
                    keyword: req.query.keyword || &#x27;&#x27;
                }, cb);
            },
            commonData: function (cb) {
                common.getCommonData({}, cb);
            }
        }, function (err, results) {
            var crumb = [], crumbData, options = results.commonData.options, tagName;
            if (err) {
                return next(err);
            }
            if (!results.allPosts) {
                return util.catchError({
                    status: 404,
                    code: 404,
                    message: &#x27;Page Not Found&#x27;
                }, next);
            }
            crumbData = results.allPosts.crumb;
            tagName = crumbData.tagName;
            crumb = [{
                &#x27;title&#x27;: &#x27;首页&#x27;,
                &#x27;tooltip&#x27;: &#x27;iFuyun&#x27;,
                &#x27;url&#x27;: &#x27;/&#x27;,
                &#x27;headerFlag&#x27;: false
            }, {
                &#x27;title&#x27;: &#x27;标签&#x27;,
                &#x27;tooltip&#x27;: &#x27;标签&#x27;,
                &#x27;url&#x27;: &#x27;&#x27;,
                &#x27;headerFlag&#x27;: false
            }, {
                &#x27;title&#x27;: tagName,
                &#x27;tooltip&#x27;: tagName,
                &#x27;url&#x27;: &#x27;/tag/&#x27; + tag,
                &#x27;headerFlag&#x27;: true
            }];

            resData.postsData = results.allPosts;
            resData.postsData.paginator = util.paginator(page, results.allPosts.pages, pagesOut);
            resData.postsData.linkUrl = &#x27;/tag/&#x27; + tag + &#x27;/page-&#x27;;
            resData.postsData.linkParam = &#x27;&#x27;;

            resData.curNav = &#x27;index&#x27;;
            resData.curPos = base.createCrumb(crumb);

            if (page &gt; 1) {
                resData.meta.title = util.getTitle([&#x27;第&#x27; + page + &#x27;页&#x27;, tagName, &#x27;标签&#x27;, options.site_name.option_value]);
            } else {
                resData.meta.title = util.getTitle([tagName, &#x27;标签&#x27;, options.site_name.option_value]);
            }

            resData.meta.description = &#x27;[&#x27; + tagName + &#x27;]&#x27; + (page &gt; 1 ? &#x27;(第&#x27; + page + &#x27;页)&#x27; : &#x27;&#x27;) + options.site_description.option_value;
            resData.meta.keywords = tagName + &#x27;,&#x27; + options.site_keywords.option_value;
            resData.meta.author = options.site_author.option_value;

            Object.assign(resData, results.commonData);

            resData.util = util;

            res.render(&#x27;v2/pages/postList&#x27;, resData);
        });
    },
    /**
     * 显示文章编辑列表
     * @method listEdit
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    listEdit: function (req, res, next) {
        &#x27;use strict&#x27;;
        var page = parseInt(req.params.page, 10) || 1, resData = {
            meta: {
                title: &#x27;&#x27;
            },
            curStatus: &#x27;&#x27;
        }, param;

        param = {
            page: page,
            postStatus: req.query.status || &#x27;all&#x27;,
            postDate: req.query.date || &#x27;&#x27;,
            category: req.query.category || &#x27;&#x27;,
            tag: req.query.tag || &#x27;&#x27;,
            author: req.query.author || &#x27;&#x27;,
            keyword: req.query.keyword || &#x27;&#x27;,
            fromAdmin: true
        };
        if (req.query.type === &#x27;page&#x27;) {
            resData.page = &#x27;page&#x27;;
            param.type = &#x27;page&#x27;;

            async.parallel({
                allPosts: function (cb) {
                    post.getAllPosts(param, cb);
                },
                archiveDates: function (cb) {
                    post.getArchiveDates(param.type, cb);
                },
                options: common.getOptions,
                countAll: function (cb) {
                    post.getPostCount([&#x27;publish&#x27;, &#x27;private&#x27;, &#x27;draft&#x27;, &#x27;auto-draft&#x27;, &#x27;trash&#x27;], &#x27;page&#x27;, cb);
                },
                countPublish: function (cb) {
                    post.getPostCount(&#x27;publish&#x27;, &#x27;page&#x27;, cb);
                },
                countArchive: function (cb) {
                    post.getPostCount(&#x27;private&#x27;, &#x27;page&#x27;, cb);
                },
                countDraft: function (cb) {
                    post.getPostCount([&#x27;draft&#x27;, &#x27;auto-draft&#x27;], &#x27;page&#x27;, cb);
                },
                countDeleted: function (cb) {
                    post.getPostCount(&#x27;trash&#x27;, &#x27;page&#x27;, cb);
                }
            }, function (err, results) {
                var paramArr = [], titleArr = [], options = results.options;
                if (err) {
                    return next(err);
                }
                paramArr.push(&#x27;type=&#x27; + req.query.type);
                if (param.keyword) {
                    paramArr.push(&#x27;keyword=&#x27; + param.keyword);
                    titleArr.push(param.keyword, &#x27;搜索&#x27;);
                }
                if (req.query.status) {//TODO:英文转中文
                    paramArr.push(&#x27;status=&#x27; + param.postStatus);
                    titleArr.push(param.postStatus, &#x27;状态&#x27;);
                }
                if (param.postDate) {
                    paramArr.push(&#x27;date=&#x27; + param.postDate);
                    titleArr.push(param.postDate, &#x27;日期&#x27;);
                }
                if (results.allPosts) {
                    resData.postsData = results.allPosts;
                    resData.paginator = util.paginator(page, results.allPosts.pages, pagesOut);
                    resData.paginator.pageLimit = resData.postsData.pageLimit;
                    resData.paginator.total = resData.postsData.total;
                    resData.paginator.linkUrl = &#x27;/admin/post/page-&#x27;;
                    resData.paginator.linkParam = paramArr.length &gt; 0 ? &#x27;?&#x27; + paramArr.join(&#x27;&amp;&#x27;) : &#x27;&#x27;;
                } else {//必须设置该字段
                    resData.postsData = &#x27;&#x27;;
                }

                if (page &gt; 1) {
                    resData.meta.title = util.getTitle(titleArr.concat([&#x27;第&#x27; + page + &#x27;页&#x27;, &#x27;页面列表&#x27;, &#x27;管理后台&#x27;, options.site_name.option_value]));
                } else {
                    resData.meta.title = util.getTitle(titleArr.concat([&#x27;页面列表&#x27;, &#x27;管理后台&#x27;, options.site_name.option_value]));
                }

                resData.curStatus = param.postDate ? &#x27;&#x27; : param.postStatus;
                resData.curDate = param.postDate;
                resData.curKeyword = param.keyword;
                resData.options = options;
                resData.util = util;

                resData.archiveDates = results.archiveDates;

                resData.count = {
                    all: results.countAll.total,
                    publish: results.countPublish.total,
                    archive: results.countArchive.total,
                    draft: results.countDraft.total,
                    trash: results.countDeleted.total
                };
                res.render(&#x27;admin/pages/p_page_list&#x27;, resData);
            });
        } else {
            resData.page = &#x27;post&#x27;;
            param.type = &#x27;post&#x27;;

            async.parallel({
                allPosts: function (cb) {
                    if (req.query.category) {//TODO:分类和标签同时查询的情况
                        post.getPostsByCategories(param, cb);
                    } else if (req.query.tag) {//&quot;&amp;nbsp;&quot;等含特殊字符的处理及IE 11乱码问题: 需要显式encodeURIComponent
                        post.getPostsByTag(param, cb);
                    } else {
                        post.getAllPosts(param, cb);
                    }
                },
                categories: common.getCategoryArray,
                archiveDates: function (cb) {
                    post.getArchiveDates(param.type, cb);
                },
                options: common.getOptions,
                countAll: function (cb) {
                    post.getPostCount([&#x27;publish&#x27;, &#x27;private&#x27;, &#x27;draft&#x27;, &#x27;auto-draft&#x27;, &#x27;trash&#x27;], &#x27;post&#x27;, cb);
                },
                countPublish: function (cb) {
                    post.getPostCount(&#x27;publish&#x27;, &#x27;post&#x27;, cb);
                },
                countArchive: function (cb) {
                    post.getPostCount(&#x27;private&#x27;, &#x27;post&#x27;, cb);
                },
                countDraft: function (cb) {
                    post.getPostCount([&#x27;draft&#x27;, &#x27;auto-draft&#x27;], &#x27;post&#x27;, cb);
                },
                countDeleted: function (cb) {
                    post.getPostCount(&#x27;trash&#x27;, &#x27;post&#x27;, cb);
                }
            }, function (err, results) {
                var paramArr = [], titleArr = [], options = results.options;
                if (err) {
                    return next(err);
                }
                if (param.keyword) {
                    paramArr.push(&#x27;keyword=&#x27; + param.keyword);
                    titleArr.push(param.keyword, &#x27;搜索&#x27;);
                }
                if (req.query.status) {//TODO:英文转中文
                    paramArr.push(&#x27;status=&#x27; + param.postStatus);
                    titleArr.push(param.postStatus, &#x27;状态&#x27;);
                }
                if (param.postDate) {
                    paramArr.push(&#x27;date=&#x27; + param.postDate);
                    titleArr.push(param.postDate, &#x27;日期&#x27;);
                }
                if (param.category) {//TODO:英文转中文
                    paramArr.push(&#x27;category=&#x27; + param.category);
                    titleArr.push(param.category, &#x27;分类&#x27;);
                }
                if (param.tag) {
                    paramArr.push(&#x27;tag=&#x27; + param.tag);
                    titleArr.push(param.tag, &#x27;标签&#x27;);
                }
                if (param.author) {//TODO:作者
                    paramArr.push(&#x27;author=&#x27; + param.author);
                    // titleArr.push(param.author);
                }
                if (results.allPosts) {
                    resData.postsData = results.allPosts;
                    resData.paginator = util.paginator(page, results.allPosts.pages, pagesOut);
                    resData.paginator.pageLimit = resData.postsData.pageLimit;
                    resData.paginator.total = resData.postsData.total;
                    resData.paginator.linkUrl = &#x27;/admin/post/page-&#x27;;
                    resData.paginator.linkParam = paramArr.length &gt; 0 ? &#x27;?&#x27; + paramArr.join(&#x27;&amp;&#x27;) : &#x27;&#x27;;
                } else {//必须设置该字段
                    resData.postsData = &#x27;&#x27;;
                }

                if (page &gt; 1) {
                    resData.meta.title = util.getTitle(titleArr.concat([&#x27;第&#x27; + page + &#x27;页&#x27;, &#x27;文章列表&#x27;, &#x27;管理后台&#x27;, options.site_name.option_value]));
                } else {
                    resData.meta.title = util.getTitle(titleArr.concat([&#x27;文章列表&#x27;, &#x27;管理后台&#x27;, options.site_name.option_value]));
                }

                resData.curStatus = param.postDate || param.category || param.tag || param.author ? &#x27;&#x27; : param.postStatus;
                resData.curCategory = param.category;
                resData.curDate = param.postDate;
                resData.curKeyword = param.keyword;
                resData.options = options;
                resData.util = util;

                resData.categories = results.categories;
                resData.archiveDates = results.archiveDates;

                resData.count = {
                    all: results.countAll.total,
                    publish: results.countPublish.total,
                    archive: results.countArchive.total,
                    draft: results.countDraft.total,
                    trash: results.countDeleted.total
                };
                res.render(&#x27;admin/pages/p_post_list&#x27;, resData);
            });
        }
    },
    /**
     * 新建文章
     * @method newPost
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    newPost: function (req, res, next) {
        &#x27;use strict&#x27;;
        var resData = {
            meta: {
                title: &#x27;&#x27;
            },
            categories: false,
            token: req.csrfToken()
        };

        async.parallel({
            categories: common.getCategoryArray,
            options: common.getOptions
        }, function (err, results) {
            var options = results.options;
            if (err) {
                return next(err);
            }
            resData.meta.title = util.getTitle([&#x27;撰写新文章&#x27;, &#x27;管理后台&#x27;, options.site_name.option_value]);

            resData.categories = results.categories;
            resData.options = options;

            if (req.query.type === &#x27;page&#x27;) {
                resData.page = &#x27;page&#x27;;
                res.render(&#x27;admin/pages/p_page_form&#x27;, resData);
            } else {
                resData.page = &#x27;post&#x27;;
                res.render(&#x27;admin/pages/p_post_form&#x27;, resData);
            }
        });
    },
    /**
     * 保存文章
     * @method savePost
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    savePost: function (req, res, next) {
        &#x27;use strict&#x27;;
        var params = req.body,
            referer = req.session.referer,
            type = req.query.type;

        if (!type || type !== &#x27;page&#x27;) {
            type = &#x27;post&#x27;;
        }

        //postTitle, postContent, postExcerpt, postTag;
        //params.postContent不能过滤，否则将过滤掉属性
        params.postTitle = xss.sanitize(params.postTitle);
        params.postExcerpt = xss.sanitize(params.postExcerpt);
        params.postTag = xss.sanitize(params.postTag);
        params.postCategory = typeof params.postCategory === &#x27;string&#x27; ? params.postCategory.split(&#x27;,&#x27;) : params.postCategory;
        params.user = req.session.user;
        params.postId = xss.sanitize(params.postId);
        params.postUrl = xss.sanitize(params.postUrl);
        params.type = type;

        if (typeof params.postTag === &#x27;string&#x27;) {
            params.postTag = params.postTag.trim();
            if (params.postTag === &#x27;&#x27;) {
                params.postTag = [];
            } else {
                params.postTag = params.postTag.split(/[,\s]/i);
            }
        } else if (!util.isArray(params.postTag)) {
            params.postTag = [];
        }

        if (!params.postId || !idReg.test(params.postId)) {//空或者不符合ID规则
            params.postId = &#x27;&#x27;;
        }
        params.postId = params.postId.trim();
        //trim shouldn&#x27;t be null or undefined
        if (!params.postStatus) {
            return util.catchError({
                status: 200,
                code: 400,
                message: &#x27;状态不能为空&#x27;
            }, next);
        }
        if (!params.postTitle.trim()) {
            return util.catchError({
                status: 200,
                code: 400,
                message: &#x27;标题不能为空&#x27;
            }, next);
        }
        if (!params.postContent.trim()) {
            return util.catchError({
                status: 200,
                code: 400,
                message: &#x27;内容不能为空&#x27;
            }, next);
        }
        if (type === &#x27;post&#x27; &amp;&amp; (!params.postCategory || params.postCategory.length &lt; 1)) {
            return util.catchError({
                status: 200,
                code: 400,
                message: &#x27;目录不能为空&#x27;
            }, next);
        }
        if (type === &#x27;post&#x27; &amp;&amp; params.postCategory.length &gt; 5) {
            return util.catchError({
                status: 200,
                code: 400,
                message: &#x27;目录数应不大于5个&#x27;
            }, next);
        }
        if (type === &#x27;post&#x27; &amp;&amp; params.postTag.length &gt; 10) {
            return util.catchError({
                status: 200,
                code: 400,
                message: &#x27;标签数应不大于10个&#x27;
            }, next);
        }
        if (params.postStatus === &#x27;password&#x27; &amp;&amp; !params.postPassword.trim()) {
            return util.catchError({
                status: 200,
                code: 400,
                message: &#x27;密码不能为空&#x27;
            }, next);
        }
        if (type === &#x27;page&#x27; &amp;&amp; !params.postUrl.trim()) {
            return util.catchError({
                status: 200,
                code: 400,
                message: &#x27;URL不能为空&#x27;
            }, next);
        }

        async.auto({
            // options: common.getOptions,
            // post: [&#x27;options&#x27;, function (cb, result) {
            //     post.savePost(params, result.options, cb);
            // }]
            post: function (cb) {
                post.savePost(params, cb);
            }
        }, function (err, results) {
            if (err) {
                next(err);
            } else {
                delete(req.session.referer);

                res.set(&#x27;Content-type&#x27;, &#x27;application/json&#x27;);
                res.send({
                    status: 200,
                    code: 0,
                    message: null,
                    data: {
                        url: referer || &#x27;/admin/post?type=&#x27; + type
                    }
                });
            }
        });
    },
    /**
     * 修改文章
     * @method editPost
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.0.0
     * @since 1.0.0
     */
    editPost: function (req, res, next) {
        &#x27;use strict&#x27;;
        var postId = req.params.postId, resData;

        if (!postId || !idReg.test(postId)) {
            return util.catchError({
                status: 404,
                code: 404,
                message: &#x27;文章不存在&#x27;
            }, next);
        }

        req.session.referer = req.headers.referer;

        resData = {
            meta: {
                title: &#x27;&#x27;
            },
            categories: false,
            token: req.csrfToken()
        };

        async.parallel({
            post: function (cb) {
                post.getPostById(postId, &#x27;id&#x27;, util.isAdminUser(req), function (err, data) {
                    if (err || !data.post || !data.post.post_id) {
                        logger.error(util.getErrorLog({
                            req: req,
                            funcName: &#x27;editPost&#x27;,
                            funcParam: {
                                postId: postId
                            },
                            msg: err
                        }));
                        return cb(util.catchError({
                            status: 404,
                            code: 404,
                            message: &#x27;Page Not Found&#x27;
                        }));
                    }
                    cb(null, data);
                });
            },
            categories: common.getCategoryArray,
            options: common.getOptions
        }, function (err, results) {
            var curPost = results.post, options = results.options, tagIdx, tagArr = [], catIdx, catArr = [], postType;
            if (err) {
                return next(err);
            }
            postType = results.post.post.post_type;
            resData.meta.title = util.getTitle([postType === &#x27;post&#x27; ? &#x27;编辑文章&#x27; : &#x27;编辑页面&#x27;, &#x27;管理后台&#x27;, options.site_name.option_value]);

            for (tagIdx = 0; tagIdx &lt; curPost.tag.length; tagIdx += 1) {
                tagArr.push(curPost.tag[tagIdx].name);
            }
            for (catIdx = 0; catIdx &lt; curPost.category.length; catIdx += 1) {
                catArr.push(curPost.category[catIdx].taxonomy_id);
            }
            resData.util = util;
            resData.postCategories = catArr;

            resData.post = results.post;
            resData.categories = results.categories;
            resData.postTags = tagArr.join(&#x27;,&#x27;);
            resData.options = options;

            if (postType === &#x27;page&#x27;) {
                resData.page = &#x27;page&#x27;;
                res.render(&#x27;admin/pages/p_page_form_edit&#x27;, resData);
            } else {
                resData.page = &#x27;post&#x27;;
                res.render(&#x27;admin/pages/p_post_form_edit&#x27;, resData);
            }
        });
    },
    /**
     * 批量保存
     * @method batchSave
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @unimplemented
     */
    batchSave: function (req, res, next) {//TODO
        &#x27;use strict&#x27;;
    },
    /**
     * 删除文章
     * @method removePost
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @unimplemented
     */
    removePost: function (req, res, next) {//TODO
        &#x27;use strict&#x27;;
    },
    /**
     * 多媒体列表
     * @method listMedia
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.2.0
     * @since 1.2.0
     */
    listMedia: function (req, res, next) {
        &#x27;use strict&#x27;;
        var page = parseInt(req.params.page, 10) || 1, resData = {
            meta: {
                title: &#x27;&#x27;
            },
            page: &#x27;media&#x27;,
            curStatus: &#x27;&#x27;
        }, param;

        param = {
            page: page,
            postStatus: req.query.status || &#x27;all&#x27;,
            postDate: req.query.date || &#x27;&#x27;,
            type: &#x27;attachment&#x27;,
            author: req.query.author || &#x27;&#x27;,
            keyword: req.query.keyword || &#x27;&#x27;,
            fromAdmin: true
        };
        async.parallel({
            allMedia: function (cb) {
                post.getAllPosts(param, cb);
            },
            options: common.getOptions,
            archiveDates: function (cb) {
                post.getArchiveDates(param.type, cb);
            },
            countAll: function (cb) {
                post.getPostCount([&#x27;publish&#x27;, &#x27;private&#x27;, &#x27;draft&#x27;, &#x27;auto-draft&#x27;, &#x27;trash&#x27;], param.type, cb);
            },
            countDeleted: function (cb) {
                post.getPostCount(&#x27;trash&#x27;, param.type, cb);
            }
        }, function (err, results) {
            var paramArr = [], titleArr = [], options = results.options;

            if (param.keyword) {
                paramArr.push(&#x27;keyword=&#x27; + param.keyword);
                titleArr.push(param.keyword, &#x27;搜索&#x27;);
            }
            if (req.query.status) {//TODO:英文转中文
                paramArr.push(&#x27;status=&#x27; + param.postStatus);
                titleArr.push(param.postStatus, &#x27;状态&#x27;);
            }
            if (param.postDate) {
                paramArr.push(&#x27;date=&#x27; + param.postDate);
                titleArr.push(param.postDate, &#x27;日期&#x27;);
            }
            if (param.author) {//TODO:作者
                paramArr.push(&#x27;author=&#x27; + param.author);
                // titleArr.push(param.author);
            }

            if (results.allMedia) {
                resData.postsData = results.allMedia;
                resData.paginator = util.paginator(page, results.allMedia.pages, pagesOut);
                resData.paginator.pageLimit = resData.postsData.pageLimit;
                resData.paginator.total = resData.postsData.total;
                resData.paginator.linkUrl = &#x27;/admin/media/page-&#x27;;
                resData.paginator.linkParam = &#x27;&#x27;;
            } else {//必须设置该字段
                resData.postsData = &#x27;&#x27;;
            }

            if (page &gt; 1) {
                resData.meta.title = util.getTitle(titleArr.concat([&#x27;第&#x27; + page + &#x27;页&#x27;, &#x27;多媒体列表&#x27;, &#x27;管理后台&#x27;, options.site_name.option_value]));
            } else {
                resData.meta.title = util.getTitle(titleArr.concat([&#x27;多媒体列表&#x27;, &#x27;管理后台&#x27;, options.site_name.option_value]));
            }

            resData.curStatus = param.postStatus;
            resData.curDate = param.postDate;
            resData.curKeyword = param.keyword;
            resData.options = options;
            resData.util = util;
            resData.archiveDates = results.archiveDates;

            resData.count = {
                all: results.countAll.total,
                trash: results.countDeleted.total
            };
            res.render(&#x27;admin/pages/p_media_list&#x27;, resData);

        });
    },
    /**
     * 新增多媒体
     * @method newMedia
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.2.0
     * @since 1.2.0
     */
    newMedia: function (req, res, next) {
        &#x27;use strict&#x27;;
        var resData = {
            meta: {
                title: &#x27;&#x27;
            },
            page: &#x27;media&#x27;,
            token: req.csrfToken()
        };

        async.parallel({
            options: common.getOptions
        }, function (err, results) {
            var options = results.options;
            if (err) {
                return next(err);
            }
            resData.meta.title = util.getTitle([&#x27;上传新媒体文件&#x27;, &#x27;管理后台&#x27;, options.site_name.option_value]);

            resData.options = options;

            res.render(&#x27;admin/pages/p_media_form&#x27;, resData);
        });
    },
    /**
     * 上传多媒体文件
     * @method uploadFile
     * @static
     * @param {Object} req 请求对象
     * @param {Object} res 响应对象
     * @param {Object} next 路由对象
     * @return {void}
     * @author Fuyun
     * @version 1.2.0
     * @since 1.2.0
     */
    uploadFile: function (req, res, next) {
        var form = new formidable.IncomingForm(), yearPath, uploadPath, now = moment(), that = this, curYear = now.format(&#x27;YYYY&#x27;), curMonth = now.format(&#x27;MM&#x27;);
        var fileData = {};

        yearPath = path.join(__dirname, &#x27;..&#x27;, &#x27;public&#x27;, &#x27;upload&#x27;, curYear);
        uploadPath = path.join(yearPath, curMonth);
        if (!fs.existsSync(yearPath)) {
            fs.mkdirSync(yearPath);
        }
        if (!fs.existsSync(uploadPath)) {
            fs.mkdirSync(uploadPath);
        }
        form.uploadDir = uploadPath;
        form.keepExtensions = true;
        form.maxFieldsSize = 200 * 1024 * 1024;

        form.on(&#x27;progress&#x27;, function (bytesReceived, bytesExpected) {
            // console.log(bytesReceived, bytesExpected);
        });
        form.on(&#x27;field&#x27;, function (name, value) {
            // console.log(&#x27;field&#x27;, name, value);
        });
        form.on(&#x27;file&#x27;, function (name, file) {
            // console.log(&#x27;file&#x27;, name, file);
        });
        form.on(&#x27;end&#x27;, function () {
            // res.set(&#x27;Content-type&#x27;, &#x27;application/json&#x27;);
            // res.send({
            //     code: 200,
            //     msg: &#x27;test&#x27;
            // });
        });
        form.on(&#x27;error&#x27;, function (err) {
            logger.error(util.getErrorLog({
                req: req,
                funcName: &#x27;uploadFile&#x27;,//TODO:func.name
                funcParam: {
                    uploadPath: uploadPath
                },
                msg: err
            }));
        });
        form.parse(req, function (err, fields, files) {
            var fileExt = files.mediafile.name.split(&#x27;.&#x27;);
            if (fileExt.length &gt; 1) {
                fileExt = &#x27;.&#x27; + fileExt.pop();
            } else {
                fileExt = &#x27;&#x27;;
            }
            var filename = util.getUuid() + fileExt;
            var filepath = path.join(uploadPath, filename);
            fs.renameSync(files.mediafile.path, filepath);

            fileData.postTitle = fileData.postExcerpt = fileData.postContent = xss.sanitize(files.mediafile.name);
            fileData.postCategory = &#x27;&#x27;;
            fileData.user = req.session.user;
            fileData.postUrl = &#x27;&#x27;;
            fileData.postStatus = &#x27;publish&#x27;;
            fileData.type = &#x27;attachment&#x27;;
            fileData.postTag = [];
            fileData.postId = &#x27;&#x27;;
            fileData.postUrl = &#x27;/static/&#x27; + curYear + &#x27;/&#x27; + curMonth + &#x27;/&#x27; + filename;

            async.auto({
                post: function (cb) {
                    post.savePost(fileData, cb);
                }
            }, function (err, results) {
                if (err) {
                    next(err);
                } else {
                    delete(req.session.referer);

                    res.set(&#x27;Content-type&#x27;, &#x27;application/json&#x27;);
                    res.send({
                        status: 200,
                        code: 0,
                        message: null,
                        data: {
                            url: &#x27;/admin/media&#x27;
                        }
                    });
                }
            });

            logger.info(util.getInfoLog({
                req: req,
                funcName: &#x27;uploadFile&#x27;,//TODO:func.name
                funcParam: {
                    uploadPath: uploadPath,
                    filename: files.mediafile.name
                },
                msg: &#x27;Upload file: &#x27; + filename
            }));
        });
    }
};

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
